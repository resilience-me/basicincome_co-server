{"filter":false,"title":"subscribe.js","tooltip":"/subscribe.js","undoManager":{"mark":100,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":37,"column":46},"end":{"row":37,"column":47},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":47},"end":{"row":37,"column":48},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":48},"end":{"row":37,"column":49},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":49},"end":{"row":37,"column":50},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":50},"end":{"row":37,"column":51},"action":"insert","lines":["k"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":51},"end":{"row":37,"column":52},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":51},"end":{"row":37,"column":52},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":50},"end":{"row":37,"column":51},"action":"remove","lines":["k"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":50},"end":{"row":37,"column":51},"action":"insert","lines":["j"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":51},"end":{"row":37,"column":52},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":32},"end":{"row":37,"column":33},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":33},"end":{"row":37,"column":34},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":34},"end":{"row":37,"column":35},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":35},"end":{"row":37,"column":36},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":36},"end":{"row":37,"column":37},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":37},"end":{"row":37,"column":38},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":38},"end":{"row":37,"column":39},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":39},"end":{"row":37,"column":40},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":40},"end":{"row":37,"column":41},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":41},"end":{"row":37,"column":42},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":41},"end":{"row":37,"column":42},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":41},"end":{"row":37,"column":42},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":42},"end":{"row":37,"column":43},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":43},"end":{"row":37,"column":44},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":44},"end":{"row":37,"column":45},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":45},"end":{"row":37,"column":46},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":46},"end":{"row":37,"column":47},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":47},"end":{"row":37,"column":48},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":48},"end":{"row":37,"column":49},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":49},"end":{"row":37,"column":50},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":50},"end":{"row":37,"column":51},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":37,"column":51},"end":{"row":37,"column":52},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":57,"column":0},"end":{"row":58,"column":0},"action":"remove","lines":["var COLLECTION = db.collection(data.transaction.Destination);",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":2,"column":69},"action":"remove","lines":["// the server module collects data from a financial platform","// this example collects data from Ripple","// you could easily create a module for BTC, or Ethereum, or whatever"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":1,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":1,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":31},"end":{"row":103,"column":0},"action":"remove","lines":["","","// swarm-scanner","var swarm = require('./swarm_redistribution.js')","",""," /* Loading ripple-lib with Node.js */","var ripple = require('ripple-lib')","var Remote = ripple.Remote;","","","var remote = new Remote({","  // see the API Reference for available options","  servers: [ 'wss://s1.ripple.com:443' ]","});","","remote.connect(function() {","    console.log(\"connected to Ripple\")","  /* remote connected */","","});//end remote connect","","var get_all_collections =require('./get_all_collections.js')","get_all_collections.get_all_collections(function(accounts){","                request_subscribe(accounts)","","})","","","","// ----- STANDARDIZED SCRIPT -----","// add your financial platform here, here's code for Ripple","","var connect_ripple = require('./financial_platforms/connect_to_ripple.js')","","","// ---------------------------- connect to rippled -----------------------------","","function request_subscribe(accounts){","    ","// ---------------------------- connect to ripple-lib -----------------------------","","","var req = remote.request_subscribe();","req.message.accounts = accounts","console.log(req.message.accounts)","req.request();","remote.on('transaction', function(data){"," ","","","// ---------------------------- connect transaction","","","// filter out transactions","","","","","// filter by currency","if(data.transaction.TransactionType === 'Payment'){","console.log(data.transaction.TransactionType + \"scanned\")","if(data.transaction.Amount.currency === \"RES\"){","    ","console.log(data.transaction)","console.log(data.engine_result_message)","    ","                transaction()","","}","}","","function transaction(){","        ","    //get taxRate","     db.collection(data.transaction.Destination).findOne({type: \"contract\", currency: data.transaction.Amount.currency}, function(err,doc){","            var taxRate;","","            if(doc === null)consumption_outside_network()","            else{","            taxRate = doc.taxRate","            console.log(taxRate)","            connect_transaction(data.transaction.Account, data.transaction.Destination, data.transaction.Amount.currency, data.transaction.Amount.value, taxRate)","            } ","    }) ","   ","}  ","         ","function consumption_outside_network(){","    ","    // upsert extra-network consumption","    db.collection(data.transaction.Account).findAndModify({","        query: {type: \"consumption_outside_network\", currency: data.transaction.Amount.currency}, ","        update:{$inc:{total_amount:Number(data.transaction.Amount.value)}}, ","        upsert: true,","        new: true","        ","    }, ","        function(err,doc){","            console.log(doc)","        })    ","    ","}",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":8},"end":{"row":0,"column":15},"action":"remove","lines":["connect"]},{"start":{"row":0,"column":8},"end":{"row":0,"column":9},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":9},"end":{"row":0,"column":10},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":10},"end":{"row":0,"column":11},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":11},"end":{"row":0,"column":12},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":12},"end":{"row":0,"column":13},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":13},"end":{"row":0,"column":14},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":14},"end":{"row":0,"column":15},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":15},"end":{"row":0,"column":16},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":16},"end":{"row":0,"column":17},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":17},"end":{"row":0,"column":18},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":18},"end":{"row":0,"column":19},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":19},"end":{"row":0,"column":20},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":20},"end":{"row":0,"column":21},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":21},"end":{"row":0,"column":22},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":22},"end":{"row":0,"column":23},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":23},"end":{"row":0,"column":24},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":24},"end":{"row":0,"column":25},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":25},"end":{"row":0,"column":26},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":26},"end":{"row":0,"column":27},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":41},"end":{"row":0,"column":42},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":42},"end":{"row":0,"column":43},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":43},"end":{"row":0,"column":44},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":44},"end":{"row":0,"column":45},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":45},"end":{"row":0,"column":46},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":46},"end":{"row":0,"column":47},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":47},"end":{"row":0,"column":48},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":48},"end":{"row":0,"column":49},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":49},"end":{"row":0,"column":50},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":49},"end":{"row":0,"column":50},"action":"remove","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":48},"end":{"row":0,"column":49},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":47},"end":{"row":0,"column":48},"action":"remove","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":46},"end":{"row":0,"column":47},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":45},"end":{"row":0,"column":46},"action":"remove","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":44},"end":{"row":0,"column":45},"action":"remove","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":43},"end":{"row":0,"column":44},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":43},"end":{"row":0,"column":90},"action":"insert","lines":["account, destination, currency, amount, taxRate"]}]}],[{"group":"doc","deltas":[{"start":{"row":2,"column":0},"end":{"row":6,"column":80},"action":"remove","lines":["// ----- STANDARDIZED SCRIPT -------","","// connect transaction to network","              ","function connect_transaction(account, destination, currency, amount, taxRate){  "]}]}],[{"group":"doc","deltas":[{"start":{"row":131,"column":0},"end":{"row":241,"column":0},"action":"remove","lines":["","/*              ","function update_collection(taxRate){    ","        ",""," ","        ","        ","    // upsert dividend_pathways","    db.collection(data.transaction.Destination).findAndModify({","        query: {type: \"dividend_pathway\", account: data.transaction.Account, currency: data.transaction.Amount.currency, taxRate: taxRate}, ","        update:{$inc:{total_pathway:Number(data.transaction.Amount.value)}}, ","        upsert: true,","        new: true","        ","    }, ","        function(err,doc){","            console.log(doc)","        })","        ","    // upsert safety_net pathway (mirror of dividend pathway)","    db.collection(data.transaction.Account).findAndModify({","        query: {type: \"safety_net_pathway\", account: data.transaction.Destination, currency: data.transaction.Amount.currency, taxRate: taxRate}, ","        update:{$inc:{total_pathway:Number(data.transaction.Amount.value)}}, ","        upsert: true,","        new: true","        ","    }, ","        function(err,doc){","            console.log(doc)","        })","","        ","   // upsert safety net (sum of all safety_net_pathways)","    db.collection(data.transaction.Account).findAndModify({","        query: {type: \"total_safety_net\", currency: data.transaction.Amount.currency, taxRate: taxRate}, ","        update:{$inc:{total_pathway:Number(data.transaction.Amount.value)}}, ","        upsert: true,","        new: true","        ","    }, ","        function(err,doc){","            console.log(doc)","        })"," COLLECTION.findAndModify({","        query: {type: \"tax_blob\", currency: data.transaction.Amount.currency}, ","        update:{$inc:{total_amount:Number(data.transaction.Amount.value)*taxRate}}, ","        upsert: true,","        new: true","        ","    }, ","        function(err,doc){","        })","","// ------------------------- upsert accumulated dividends","","// need swarm-algorithm","","","","","swarm.compute_swarm(data.transaction.Account, upsert_accumulated_dividend)","","","function upsert_accumulated_dividend(lines) {","","var dividend_piece = data.transaction.Amount.value / lines.length","",""," for(var i=0;i<lines.length;i++){","        console.log(lines[i].account)","        ","        ","          // upsert safety net (sum of all safety_net_pathways)","    db.collection(lines[i].account).findAndModify({","        query: {type: \"accumulated_dividends\", currency: data.transaction.Amount.currency}, ","        update:{$inc:{accumulated_amount:Number(dividend_piece)}}, ","        upsert: true,","        new: true","        ","    }, ","        function(err,doc){","            console.log(doc)","        })","        ","    }","","","}","        ","        ","    }","","*/","","        ","","// ---------------------------- connect BTC-transaction","/*","if(accounts.indexOf(data.transaction.Destination) === -1){","    ","console.log(data.transaction.Account + \" consumed outside the network\")","    ","}","","*/","","})//end remote.on","}//end request_subscribe()","",""]}]}],[{"group":"doc","deltas":[{"start":{"row":133,"column":0},"end":{"row":138,"column":0},"action":"remove","lines":["","","}//end module.exports","    ","    ",""]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":7},"end":{"row":130,"column":26},"action":"remove","lines":["connect_transaction"]},{"start":{"row":130,"column":7},"end":{"row":130,"column":8},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":8},"end":{"row":130,"column":9},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":9},"end":{"row":130,"column":10},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":9},"end":{"row":130,"column":10},"action":"remove","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":9},"end":{"row":130,"column":10},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":10},"end":{"row":130,"column":11},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":11},"end":{"row":130,"column":12},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":11},"end":{"row":130,"column":12},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":10},"end":{"row":130,"column":11},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":9},"end":{"row":130,"column":10},"action":"remove","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":9},"end":{"row":130,"column":10},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":10},"end":{"row":130,"column":11},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":11},"end":{"row":130,"column":12},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":12},"end":{"row":130,"column":13},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":13},"end":{"row":130,"column":14},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":14},"end":{"row":130,"column":15},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":15},"end":{"row":130,"column":16},"action":"insert","lines":["x"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":16},"end":{"row":130,"column":17},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":17},"end":{"row":130,"column":18},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":18},"end":{"row":130,"column":19},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":19},"end":{"row":130,"column":20},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":130,"column":20},"end":{"row":130,"column":21},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":60,"column":0},"end":{"row":62,"column":48},"action":"insert","lines":["","// swarm-scanner","var swarm = require('./swarm_redistribution.js')"]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":48},"end":{"row":63,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":1,"column":0},"end":{"row":2,"column":0},"action":"remove","lines":["",""]}]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":1,"column":0},"end":{"row":1,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1427855656001,"hash":"f6f1a84957072c81c81f4872705e4068d26c73a0"}